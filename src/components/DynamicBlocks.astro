---
import HeroSection from './HeroSection.astro';
import InspirationGrid from './InspirationGrid.astro';
import FeaturedHotels from './FeaturedHotels.astro';
import FormBlock from './FormBlock.jsx';
import JoinNow from './JoinNow.astro';
import CardBlock from './CardBlock.astro';
import ProcessTimeline from './ProcessTimeline.astro';
import TripInquiryForm from './TripInquiryForm.astro';

export interface Props {
  blocks: any[];
}

const { blocks } = Astro.props;
---

<div class="dynamic-blocks">
  {blocks.map((block: any, index: number) => {
    // Hero Section
    if (block.collection === 'block_hero' || block.collection === 'hero_section') {
      return <HeroSection data={block.item} />;
    }
    
    // Inspiration Grid
    if (block.collection === 'block_inspiration_grid' || block.collection === 'inspiration_grid') {
      return <div class="mx-auto w-full px-8 lg:w-full xl:max-w-7xl 2xl:max-w-7xl py-4">
        <InspirationGrid data={block.item} />
      </div>;
    }
    
    // Featured Hotels
    if (block.collection === 'block_featured_hotels') {
      return <div class="mx-auto w-full px-8 lg:w-full xl:max-w-7xl 2xl:max-w-7xl">
        <FeaturedHotels data={block.item} />
      </div>;
    }

    // Card Block
    if (block.collection === 'block_card') {
      return <div class="mx-auto w-full px-8 lg:w-full xl:max-w-7xl 2xl:max-w-7xl py-4">
        <CardBlock data={block.item} background={block.background} />
      </div>;
    }
    
    // Form Block
    if (block.collection === 'block_form') {
      return <div class="mx-auto w-full px-8 lg:w-full xl:max-w-7xl 2xl:max-w-7xl py-4">
        <FormBlock data={block.item} background={block.background} client:visible />
      </div>;
    }
    
    // JSON Block (para bloques dinámicos como JoinNow)
    if (block.collection === 'block_json') {
      
      // Si es un bloque de tipo benefits_grid, renderizar JoinNow
      if (block.item?.kind === 'benefits_grid') {
        // Validación adicional antes de renderizar
        if (!block.item.data) {
          console.error('DynamicBlocks - block.item.data is null for benefits_grid');
          return (
            <div class="error-block p-4 bg-red-100 border border-red-300 rounded-lg mb-8">
              <p class="text-red-700 font-medium">Error: Datos faltantes para benefits_grid</p>
              <pre class="text-xs mt-2 text-red-500 overflow-auto">{JSON.stringify(block, null, 2)}</pre>
            </div>
          );
        }
        
        return <JoinNow data={block.item.data} background={block.background} />;
      }

      // Si es un bloque de tipo process_timeline, renderizar ProcessTimeline
      if (block.item?.kind === 'process_timeline') {
        return <div class="mx-auto w-full px-8 lg:w-full xl:max-w-7xl 2xl:max-w-7xl py-4">
          <ProcessTimeline data={block.item.data} />
        </div>;
      }

      // Si es un bloque de tipo trip_inquiry_form, renderizar TripInquiryForm
      if (block.item?.kind === 'trip_inquiry_form') {
        return <TripInquiryForm data={block.item.data} />;
      }
      
      // Fallback para otros tipos de block_json
      return (
        <div class="json-block p-4 bg-gray-100 border border-gray-300 rounded-lg mb-4">
          <p class="text-gray-700 font-medium">Bloque JSON: {block.item?.kind || 'Tipo no reconocido'}</p>
          {import.meta.env.DEV && (
            <pre class="text-xs mt-2 text-gray-500 overflow-auto">{JSON.stringify(block.item, null, 2)}</pre>
          )}
        </div>
      );
    }
    
    // Content Block / Rich Text
    if (block.collection === 'content_block' || block.collection === 'block_content') {
      return (
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
          <h3 class="text-3xl font-semibold mb-4">
            {block.item?.title || 'Bloque de Contenido'}
          </h3>
          {block.item?.content && (
            <div class="prose" set:html={block.item.content} />
          )}
        </div>
      );
    }
    
    // Hero Section (fallback para el formato anterior)
    if (block.collection === 'hero_section') {
      return (
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-8 rounded-lg mb-8">
          <h2 class="text-3xl font-bold mb-4">
            {block.item?.title || 'Sección Hero'}
          </h2>
          {block.item?.description && (
            <p class="text-xl">{block.item.description}</p>
          )}
        </div>
      );
    }
    
    // Inspiration Grid (fallback para el formato anterior)
    if (block.collection === 'inspiration_grid') {
      return (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
          {block.item?.items?.map((item: any, itemIndex: number) => (
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
              {item.image && (
                <img 
                  src={`${import.meta.env.DIRECTUS_URL}/assets/${item.image.id}`}
                  alt={item.title || 'Imagen de inspiración'}
                  class="w-full h-48 object-cover"
                />
              )}
              <div class="p-4">
                <h4 class="text-lg font-semibold mb-2">
                  {item.title || 'Elemento de inspiración'}
                </h4>
                {item.description && (
                  <p class="text-gray-600">{item.description}</p>
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    // Fallback para bloques no reconocidos
    return (
      <div class="unknown-block p-4 bg-gray-100 border border-gray-300 rounded-lg mb-8">
        <p class="text-gray-700 font-medium">Bloque no reconocido: {block.collection}</p>
        {import.meta.env.DEV && (
          <pre class="text-xs mt-2 text-gray-500 overflow-auto">{JSON.stringify(block, null, 2)}</pre>
        )}
      </div>
    );
  })}
</div>

<style>
  .dynamic-blocks {
    width: 100%;
  }
  
  .unknown-block {
    padding: 2rem;
    background: #f5f5f5;
    border: 1px solid #ddd;
    margin: 1rem 0;
  }
  
  .error-block {
    padding: 2rem;
    background: #fee2e2;
    border: 1px solid #fca5a5;
    margin: 1rem 0;
  }
</style> 