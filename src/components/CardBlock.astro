---
import FormModal from './FormModal.astro';

export interface Props {
  data: {
    id: number;
    heading: string;
    image: string;
    content: string;
    tagline?: string;
    layout: string;
    btn_link: string;
    btn_cta: string;
  };
  background?: string;
}

const { data, background = 'light' } = Astro.props;

// Generar ID único para el modal
const modalId = `card-modal-${data.id}`;
---
{data.layout === 'horizontal' && (
<div class={`card-block bg-${background} mb-8 flex flex-col-reverse md:flex-row justify-between items-center`}>
  {data.image && (
    <div class="card-image mb-10 md:mb-0 w-full">
      <img 
        src={`${import.meta.env.DIRECTUS_URL}/assets/${data.image}`}
        alt={data.heading || 'Imagen de tarjeta'}
        class="w-full max-h-[430px] object-cover rounded-[2px]"
      />
    </div>
  )}
  
  <div class="flex flex-col items-center w-full p-6">
    {data.tagline && (
      <p class="text-sm text-black mb-6 font-semibold text-left w-full">{data.tagline}</p>
    )}
    
    <h2 class="card-heading text-left text-2xl font-bold mb-6 w-full">
      {data.heading}
    </h2>
    
    {data.content && (
      <div class="prose max-w-none mb-6 text-left w-full custom-list" set:html={data.content} />
    )}

    {data.btn_link && (
      <button 
        data-modal-trigger={modalId}
        class="modal-trigger font-base font-family-body text-neutral-dark border-2 border-neutral-lighter px-6 py-3 hover:bg-neutral-lighter transition-colors duration-200"
      >
        {data.btn_cta}
      </button>
    )}
  </div>
</div>
)}

{data.layout === 'horizontal_right' && (
<div class={`card-block bg-${background} mb-8 flex flex-col md:flex-row justify-between items-center`}>
  <div class="flex flex-col items-center w-full p-6">
    {data.tagline && (
      <p class="text-sm text-black mb-6 font-semibold text-left w-full">{data.tagline}</p>
    )}
    
    <h2 class="card-heading text-left text-2xl font-bold mb-6 w-full">
      {data.heading}
    </h2>
    
    {data.content && (
      <div class="prose max-w-none mb-6 text-left w-full custom-list" set:html={data.content} />
    )}

    {data.btn_link && (
      <button 
        data-modal-trigger={modalId}
        class="modal-trigger font-base font-family-body text-neutral-dark border-2 border-neutral-lighter px-6 py-3 hover:bg-neutral-lighter transition-colors duration-200 self-start"
      >
        {data.btn_cta}
      </button>
    )}
  </div>
  {data.image && (
    <div class="card-image mb-10 w-full">
      <img 
        src={`${import.meta.env.DIRECTUS_URL}/assets/${data.image}`}
        alt={data.heading || 'Imagen de tarjeta'}
        class="w-full max-h-[430px] object-cover rounded-[2px]"
      />
    </div>
  )}
</div>
)}

{data.layout === 'vertical' && (
<div class={`card-block bg-${background} p-6 mb-8 flex flex-col items-center`}>
  {data.image && (
    <div class="card-image mb-10 w-full">
      <img 
        src={`${import.meta.env.DIRECTUS_URL}/assets/${data.image}`}
        alt={data.heading || 'Imagen de tarjeta'}
        class="w-full max-h-[430px] object-cover rounded-[2px]"
      />
    </div>
  )}

  <div class="flex flex-col items-center w-[80%]">
    {data.tagline && (
      <p class="text-sm text-gray-600 mb-6 font-medium text-center">{data.tagline}</p>
    )}
  </div>

  <div class="flex flex-col items-center w-full">
    {data.content && (
      <div class="prose max-w-none mb-6 text-center" set:html={data.content} />
    )}
  </div>

  {data.btn_link && (
    <button 
      data-modal-trigger={modalId}
      class="modal-trigger font-base font-family-body text-neutral-dark border-2 border-neutral-lighter px-6 py-3 hover:bg-neutral-lighter transition-colors duration-200"
    >
      {data.btn_cta}
    </button>
  )}

</div>
)}

        <!-- FormModal para mostrar el título de la tarjeta -->
        {data.btn_link && (
          <FormModal id={modalId} title={data.heading} btnLink={data.btn_link} />
        )}

<script>
  // Función para inicializar los triggers de modal
  function initModalTriggers() {
    const triggers = document.querySelectorAll('[data-modal-trigger]');
    
    triggers.forEach(trigger => {
      // Remover listeners existentes para evitar duplicados
      trigger.removeEventListener('click', handleModalTrigger);
      trigger.addEventListener('click', handleModalTrigger);
    });
  }
  
  function handleModalTrigger(e: Event) {
    e.preventDefault();
    e.stopPropagation();
    
    const trigger = e.target as HTMLElement;
    const modalId = trigger.getAttribute('data-modal-trigger');
    console.log(modalId);
    if (modalId) {
      // Usar la función global openModal
      if ((window as any).openModal) {
        (window as any).openModal(modalId);
      }
    }
  }
  
  // Inicializar cuando se carga el DOM
  document.addEventListener('DOMContentLoaded', initModalTriggers);
  
  // Reinicializar si se carga contenido dinámicamente
  document.addEventListener('astro:page-load', initModalTriggers);
</script>

<style is:global>
  .card-block {
    transition: transform 0.2s ease-in-out;
  }
  
  .card-block:hover {
    transform: translateY(-2px);
  }
  
  .card-image img {
    transition: transform 0.3s ease-in-out;
  }
  
  .card-block:hover .card-image img {
    transform: scale(1.02);
  }
  
  .prose {
    color: #000;
    font-family: Inter;
    font-size: var(--Text-Sizes-Text-Regular, 16px);
    font-style: normal;
    font-weight: 400;
    line-height: 150%; /* 24px */
  }
  
  .prose p {
    margin-bottom: 1rem;
  }
  
  .prose p:last-child {
    margin-bottom: 0;
  }
  
  .card-heading {
    font-variation-settings: 'GRAD' 0, 'opsz' 40;
  }
  .custom-list {
    list-style: none;
    padding-left: 0;
  }
  .custom-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
  }
   .custom-list li::before {
     content: "✓" !important;
     position: absolute;
     left: 0;
     top: 0;
     color: var(--color-primary);
     font-weight: 900 !important;
     font-size: 1em;
     font-family: Arial, sans-serif;
   }
   
   .modal-trigger {
     cursor: pointer;
     border: 2px solid #e5e5e5;
     background: transparent;
     transition: all 0.2s ease-in-out;
   }
   
   .modal-trigger:hover {
     background-color: #f5f5f5;
     border-color: #d5d5d5;
   }
   
   .modal-trigger:focus {
     outline: 2px solid var(--color-primary, #3b82f6);
     outline-offset: 2px;
   }
</style>
